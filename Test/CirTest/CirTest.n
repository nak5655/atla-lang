using Nemerle;
using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using System;
using System.Collections.Generic;
using System.Linq;
using NUnit.Framework;
using Atla.Lang.Cir;

namespace Test.CirTest
{
    [TestFixture]
    class CirTest
    {
        [Test]
        public CirHelloTest(): void {
            def asm = Atla.Lang.Hir.Assembly("Test", Misc.tempFile("CirTest_Hello.exe"));
            
            def code = Misc.readCase("hello.atla");
            _ = Misc.compiler.updateModule(asm, "main", code);
            
            def _cir = Misc.compiler.compileMirToCir(Misc.compiler.compileHirToMir(asm).Value);
            def cir = _cir.Value;
            
            Assert.AreEqual(1, cir.modules.First().methods.Count());
            
            Atla.Lang.Cir.Emit().emit(cir);
        }
        
        [Test]
        public CirFibonacciTest(): void {
            def asm = Atla.Lang.Hir.Assembly("Test", Misc.tempFile("CirTest_Fibonacci.exe"));
            
            def code = Misc.readCase("fibonacci.atla");
            _ = Misc.compiler.updateModule(asm, "main", code);
            
            def mir = Misc.compiler.compileHirToMir(asm).Value;
            def _cir = Misc.compiler.compileMirToCir(Misc.compiler.compileHirToMir(asm).Value);
            def cir = _cir.Value;
            
            Atla.Lang.Cir.Emit().emit(cir);
        }
        
        [Test]
        public CirGeometryTest(): void {
            def asm = Atla.Lang.Hir.Assembly("Test", Misc.tempFile("CirTest_Geometry.exe"));
            
            def code = Misc.readCase("geometry.atla");
            _ = Misc.compiler.updateModule(asm, "main", code);
            
            def mir = Misc.compiler.compileHirToMir(asm).Value;
            def _cir = Misc.compiler.compileMirToCir(Misc.compiler.compileHirToMir(asm).Value);
            def cir = _cir.Value;
            
            Atla.Lang.Cir.Emit().emit(cir);
        }
        
        //[Test]
        //public symbolEqualityTest(): void {
        //    def a = Symbol.Method("aaa", [typeof(System.String)], typeof(void));
        //    def b = Symbol.Method("aaa", [typeof(System.String)], typeof(void));
        //    Assert.AreEqual(a, b);
        //}
        //
        //[Test]
        //public symbolHashTest(): void {
        //    def a = Symbol.Method("aaa", [typeof(System.String)], typeof(void));
        //    def b = Symbol.Method("aaa", [typeof(System.String)], typeof(void));
        //    
        //    def table: Hashtable[Symbol.Method, int] = Hashtable();
        //    table.Add(a, 0);
        //    Assert.IsTrue(table.ContainsKey(b));
        //}
    }
}
